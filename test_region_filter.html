<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Region Filter Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #console-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .region-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🌍 Region Filter Test</h1>
        <p>測試 Region 過濾功能是否正常</p>
        
        <div class="test-section">
            <h3>📊 Region 資料檢查</h3>
            <button onclick="checkRegionData()">檢查 Region 資料</button>
            <div id="region-data-result" class="status"></div>
            <div id="region-list" class="region-list" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>🔍 Filter 功能測試</h3>
            <button onclick="testRegionFilter()">測試 Region 過濾</button>
            <div id="filter-test-result" class="status"></div>
        </div>
        
        <div class="test-section">
            <h3>📈 Dashboard 更新測試</h3>
            <button onclick="testDashboardUpdate()">測試 Dashboard 更新</button>
            <div id="dashboard-test-result" class="status"></div>
        </div>
        
        <div class="test-section">
            <h3>📱 完整功能測試</h3>
            <iframe id="main-iframe" src="./index.html" width="100%" height="400" style="border: 1px solid #ddd; border-radius: 4px;"></iframe>
        </div>
        
        <div class="test-section">
            <h3>🔧 Console 輸出</h3>
            <div id="console-output"></div>
        </div>
    </div>

    <script>
        // Console 攔截
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        console.log = function(...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.textContent += `[${timestamp}] ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            originalLog.apply(console, args);
        };

        async function checkRegionData() {
            const result = document.getElementById('region-data-result');
            const regionList = document.getElementById('region-list');
            
            try {
                const response = await fetch('./data/belProfiles.json');
                const data = await response.json();
                
                console.log('✅ BEL Profiles 載入成功');
                console.log('總用戶數:', data.leaderboard.length);
                
                // 收集所有 Region
                const regionCounts = {};
                let totalWithRegion = 0;
                
                data.leaderboard.forEach(user => {
                    if (user.region) {
                        regionCounts[user.region] = (regionCounts[user.region] || 0) + 1;
                        totalWithRegion++;
                    }
                });
                
                console.log('有 Region 資料的用戶數:', totalWithRegion);
                console.log('Region 分佈:', regionCounts);
                
                const regionCount = Object.keys(regionCounts).length;
                const coverage = (totalWithRegion / data.leaderboard.length * 100).toFixed(1);
                
                if (regionCount > 0) {
                    result.className = 'status success';
                    result.innerHTML = `
                        ✅ Region 資料檢查成功<br>
                        • 找到 ${regionCount} 個不同的 Region<br>
                        • ${totalWithRegion}/${data.leaderboard.length} 用戶有 Region 資料 (${coverage}%)
                    `;
                    
                    // 顯示 Region 列表
                    regionList.style.display = 'block';
                    regionList.innerHTML = '<h4>Region 分佈:</h4>' + 
                        Object.entries(regionCounts)
                            .sort((a, b) => b[1] - a[1])
                            .map(([region, count]) => `• ${region}: ${count} 位 BEL`)
                            .join('<br>');
                } else {
                    result.className = 'status error';
                    result.innerHTML = '❌ 沒有找到 Region 資料';
                }
                
            } catch (error) {
                result.className = 'status error';
                result.innerHTML = `❌ 錯誤: ${error.message}`;
                console.error('檢查 Region 資料失敗:', error);
            }
        }

        function testRegionFilter() {
            const result = document.getElementById('filter-test-result');
            const iframe = document.getElementById('main-iframe');
            
            if (!iframe.contentDocument) {
                result.className = 'status warning';
                result.innerHTML = '⚠️ 請等待主頁面載入完成';
                return;
            }
            
            try {
                const doc = iframe.contentDocument;
                const regionSelect = doc.getElementById('header-region-filter');
                const yearSelect = doc.getElementById('header-year-filter');
                
                if (regionSelect && yearSelect) {
                    console.log('✅ 找到 Region 和 Year 選擇器');
                    console.log('Region options:', Array.from(regionSelect.options).map(opt => opt.value));
                    console.log('Year options:', Array.from(yearSelect.options).map(opt => opt.value));
                    
                    // 測試選擇不同的 Region
                    if (regionSelect.options.length > 1) {
                        const testRegion = regionSelect.options[1].value;
                        console.log(`🧪 測試選擇 Region: ${testRegion}`);
                        
                        regionSelect.value = testRegion;
                        regionSelect.dispatchEvent(new Event('change'));
                        
                        setTimeout(() => {
                            const selectedRegion = iframe.contentWindow.selectedDashboardRegion;
                            console.log('全域變數 selectedDashboardRegion:', selectedRegion);
                            
                            result.className = 'status success';
                            result.innerHTML = `
                                ✅ Region Filter 測試成功<br>
                                • 選擇的 Region: ${testRegion}<br>
                                • 全域變數已更新: ${selectedRegion === testRegion ? '是' : '否'}
                            `;
                        }, 500);
                    } else {
                        result.className = 'status warning';
                        result.innerHTML = '⚠️ Region 選擇器中沒有選項';
                    }
                } else {
                    result.className = 'status error';
                    result.innerHTML = `❌ 找不到選擇器元素: Region=${!!regionSelect}, Year=${!!yearSelect}`;
                }
                
            } catch (error) {
                result.className = 'status error';
                result.innerHTML = `❌ 錯誤: ${error.message}`;
                console.error('測試 Region Filter 失敗:', error);
            }
        }

        function testDashboardUpdate() {
            const result = document.getElementById('dashboard-test-result');
            const iframe = document.getElementById('main-iframe');
            
            if (!iframe.contentDocument) {
                result.className = 'status warning';
                result.innerHTML = '⚠️ 請等待主頁面載入完成';
                return;
            }
            
            try {
                const doc = iframe.contentDocument;
                const belCountElement = doc.querySelector('[data-stat="belCount"] .stat-value');
                const regionSelect = doc.getElementById('header-region-filter');
                
                if (belCountElement && regionSelect && regionSelect.options.length > 1) {
                    // 記錄初始 BEL 數量
                    const initialCount = belCountElement.textContent;
                    console.log('🔢 初始 BEL 數量:', initialCount);
                    
                    // 選擇特定 Region
                    const testRegion = regionSelect.options[1].value;
                    regionSelect.value = testRegion;
                    regionSelect.dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        const newCount = belCountElement.textContent;
                        console.log(`🔢 選擇 ${testRegion} 後的 BEL 數量:`, newCount);
                        
                        if (newCount !== initialCount) {
                            result.className = 'status success';
                            result.innerHTML = `
                                ✅ Dashboard 更新測試成功<br>
                                • 初始 BEL 數量: ${initialCount}<br>
                                • ${testRegion} 的 BEL 數量: ${newCount}<br>
                                • 數據有正確更新: 是
                            `;
                        } else {
                            result.className = 'status warning';
                            result.innerHTML = `
                                ⚠️ Dashboard 可能沒有更新<br>
                                • 初始和篩選後的數量相同: ${initialCount}<br>
                                • 可能該 Region 包含所有 BEL 或功能有問題
                            `;
                        }
                    }, 1000);
                } else {
                    result.className = 'status error';
                    result.innerHTML = '❌ 找不到必要的元素來測試 Dashboard 更新';
                }
                
            } catch (error) {
                result.className = 'status error';
                result.innerHTML = `❌ 錯誤: ${error.message}`;
                console.error('測試 Dashboard 更新失敗:', error);
            }
        }

        // 頁面載入時自動檢查 Region 資料
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkRegionData();
            }, 1000);
        });
    </script>
</body>
</html>
