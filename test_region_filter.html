<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Region Filter Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #console-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .region-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸŒ Region Filter Test</h1>
        <p>æ¸¬è©¦ Region éæ¿¾åŠŸèƒ½æ˜¯å¦æ­£å¸¸</p>
        
        <div class="test-section">
            <h3>ğŸ“Š Region è³‡æ–™æª¢æŸ¥</h3>
            <button onclick="checkRegionData()">æª¢æŸ¥ Region è³‡æ–™</button>
            <div id="region-data-result" class="status"></div>
            <div id="region-list" class="region-list" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” Filter åŠŸèƒ½æ¸¬è©¦</h3>
            <button onclick="testRegionFilter()">æ¸¬è©¦ Region éæ¿¾</button>
            <div id="filter-test-result" class="status"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ˆ Dashboard æ›´æ–°æ¸¬è©¦</h3>
            <button onclick="testDashboardUpdate()">æ¸¬è©¦ Dashboard æ›´æ–°</button>
            <div id="dashboard-test-result" class="status"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“± å®Œæ•´åŠŸèƒ½æ¸¬è©¦</h3>
            <iframe id="main-iframe" src="./index.html" width="100%" height="400" style="border: 1px solid #ddd; border-radius: 4px;"></iframe>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”§ Console è¼¸å‡º</h3>
            <div id="console-output"></div>
        </div>
    </div>

    <script>
        // Console æ””æˆª
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        console.log = function(...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.textContent += `[${timestamp}] ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            originalLog.apply(console, args);
        };

        async function checkRegionData() {
            const result = document.getElementById('region-data-result');
            const regionList = document.getElementById('region-list');
            
            try {
                const response = await fetch('./data/belProfiles.json');
                const data = await response.json();
                
                console.log('âœ… BEL Profiles è¼‰å…¥æˆåŠŸ');
                console.log('ç¸½ç”¨æˆ¶æ•¸:', data.leaderboard.length);
                
                // æ”¶é›†æ‰€æœ‰ Region
                const regionCounts = {};
                let totalWithRegion = 0;
                
                data.leaderboard.forEach(user => {
                    if (user.region) {
                        regionCounts[user.region] = (regionCounts[user.region] || 0) + 1;
                        totalWithRegion++;
                    }
                });
                
                console.log('æœ‰ Region è³‡æ–™çš„ç”¨æˆ¶æ•¸:', totalWithRegion);
                console.log('Region åˆ†ä½ˆ:', regionCounts);
                
                const regionCount = Object.keys(regionCounts).length;
                const coverage = (totalWithRegion / data.leaderboard.length * 100).toFixed(1);
                
                if (regionCount > 0) {
                    result.className = 'status success';
                    result.innerHTML = `
                        âœ… Region è³‡æ–™æª¢æŸ¥æˆåŠŸ<br>
                        â€¢ æ‰¾åˆ° ${regionCount} å€‹ä¸åŒçš„ Region<br>
                        â€¢ ${totalWithRegion}/${data.leaderboard.length} ç”¨æˆ¶æœ‰ Region è³‡æ–™ (${coverage}%)
                    `;
                    
                    // é¡¯ç¤º Region åˆ—è¡¨
                    regionList.style.display = 'block';
                    regionList.innerHTML = '<h4>Region åˆ†ä½ˆ:</h4>' + 
                        Object.entries(regionCounts)
                            .sort((a, b) => b[1] - a[1])
                            .map(([region, count]) => `â€¢ ${region}: ${count} ä½ BEL`)
                            .join('<br>');
                } else {
                    result.className = 'status error';
                    result.innerHTML = 'âŒ æ²’æœ‰æ‰¾åˆ° Region è³‡æ–™';
                }
                
            } catch (error) {
                result.className = 'status error';
                result.innerHTML = `âŒ éŒ¯èª¤: ${error.message}`;
                console.error('æª¢æŸ¥ Region è³‡æ–™å¤±æ•—:', error);
            }
        }

        function testRegionFilter() {
            const result = document.getElementById('filter-test-result');
            const iframe = document.getElementById('main-iframe');
            
            if (!iframe.contentDocument) {
                result.className = 'status warning';
                result.innerHTML = 'âš ï¸ è«‹ç­‰å¾…ä¸»é é¢è¼‰å…¥å®Œæˆ';
                return;
            }
            
            try {
                const doc = iframe.contentDocument;
                const regionSelect = doc.getElementById('header-region-filter');
                const yearSelect = doc.getElementById('header-year-filter');
                
                if (regionSelect && yearSelect) {
                    console.log('âœ… æ‰¾åˆ° Region å’Œ Year é¸æ“‡å™¨');
                    console.log('Region options:', Array.from(regionSelect.options).map(opt => opt.value));
                    console.log('Year options:', Array.from(yearSelect.options).map(opt => opt.value));
                    
                    // æ¸¬è©¦é¸æ“‡ä¸åŒçš„ Region
                    if (regionSelect.options.length > 1) {
                        const testRegion = regionSelect.options[1].value;
                        console.log(`ğŸ§ª æ¸¬è©¦é¸æ“‡ Region: ${testRegion}`);
                        
                        regionSelect.value = testRegion;
                        regionSelect.dispatchEvent(new Event('change'));
                        
                        setTimeout(() => {
                            const selectedRegion = iframe.contentWindow.selectedDashboardRegion;
                            console.log('å…¨åŸŸè®Šæ•¸ selectedDashboardRegion:', selectedRegion);
                            
                            result.className = 'status success';
                            result.innerHTML = `
                                âœ… Region Filter æ¸¬è©¦æˆåŠŸ<br>
                                â€¢ é¸æ“‡çš„ Region: ${testRegion}<br>
                                â€¢ å…¨åŸŸè®Šæ•¸å·²æ›´æ–°: ${selectedRegion === testRegion ? 'æ˜¯' : 'å¦'}
                            `;
                        }, 500);
                    } else {
                        result.className = 'status warning';
                        result.innerHTML = 'âš ï¸ Region é¸æ“‡å™¨ä¸­æ²’æœ‰é¸é …';
                    }
                } else {
                    result.className = 'status error';
                    result.innerHTML = `âŒ æ‰¾ä¸åˆ°é¸æ“‡å™¨å…ƒç´ : Region=${!!regionSelect}, Year=${!!yearSelect}`;
                }
                
            } catch (error) {
                result.className = 'status error';
                result.innerHTML = `âŒ éŒ¯èª¤: ${error.message}`;
                console.error('æ¸¬è©¦ Region Filter å¤±æ•—:', error);
            }
        }

        function testDashboardUpdate() {
            const result = document.getElementById('dashboard-test-result');
            const iframe = document.getElementById('main-iframe');
            
            if (!iframe.contentDocument) {
                result.className = 'status warning';
                result.innerHTML = 'âš ï¸ è«‹ç­‰å¾…ä¸»é é¢è¼‰å…¥å®Œæˆ';
                return;
            }
            
            try {
                const doc = iframe.contentDocument;
                const belCountElement = doc.querySelector('[data-stat="belCount"] .stat-value');
                const regionSelect = doc.getElementById('header-region-filter');
                
                if (belCountElement && regionSelect && regionSelect.options.length > 1) {
                    // è¨˜éŒ„åˆå§‹ BEL æ•¸é‡
                    const initialCount = belCountElement.textContent;
                    console.log('ğŸ”¢ åˆå§‹ BEL æ•¸é‡:', initialCount);
                    
                    // é¸æ“‡ç‰¹å®š Region
                    const testRegion = regionSelect.options[1].value;
                    regionSelect.value = testRegion;
                    regionSelect.dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        const newCount = belCountElement.textContent;
                        console.log(`ğŸ”¢ é¸æ“‡ ${testRegion} å¾Œçš„ BEL æ•¸é‡:`, newCount);
                        
                        if (newCount !== initialCount) {
                            result.className = 'status success';
                            result.innerHTML = `
                                âœ… Dashboard æ›´æ–°æ¸¬è©¦æˆåŠŸ<br>
                                â€¢ åˆå§‹ BEL æ•¸é‡: ${initialCount}<br>
                                â€¢ ${testRegion} çš„ BEL æ•¸é‡: ${newCount}<br>
                                â€¢ æ•¸æ“šæœ‰æ­£ç¢ºæ›´æ–°: æ˜¯
                            `;
                        } else {
                            result.className = 'status warning';
                            result.innerHTML = `
                                âš ï¸ Dashboard å¯èƒ½æ²’æœ‰æ›´æ–°<br>
                                â€¢ åˆå§‹å’Œç¯©é¸å¾Œçš„æ•¸é‡ç›¸åŒ: ${initialCount}<br>
                                â€¢ å¯èƒ½è©² Region åŒ…å«æ‰€æœ‰ BEL æˆ–åŠŸèƒ½æœ‰å•é¡Œ
                            `;
                        }
                    }, 1000);
                } else {
                    result.className = 'status error';
                    result.innerHTML = 'âŒ æ‰¾ä¸åˆ°å¿…è¦çš„å…ƒç´ ä¾†æ¸¬è©¦ Dashboard æ›´æ–°';
                }
                
            } catch (error) {
                result.className = 'status error';
                result.innerHTML = `âŒ éŒ¯èª¤: ${error.message}`;
                console.error('æ¸¬è©¦ Dashboard æ›´æ–°å¤±æ•—:', error);
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥ Region è³‡æ–™
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkRegionData();
            }, 1000);
        });
    </script>
</body>
</html>
