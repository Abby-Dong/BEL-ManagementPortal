<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Order Search Suggestions</title>
    <link rel="stylesheet" href="src/css/main.css">
</head>
<body>
    <div style="padding: 20px;">
        <h2>Test Order Search Suggestions</h2>
        
        <!-- Filter Button -->
        <button class="bel-btn secondary" id="order-filter-btn">
            <i class="fas fa-filter"></i> Filter
        </button>
        
        <!-- Filter Panel (initially hidden) -->
        <div class="filter-panel" id="order-filter-panel" style="display: none; margin-top: 10px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
            <div class="filter-group">
                <label for="order-search">Search (Order Number / Referral ID / BEL Name)</label>
                <div class="search-input-container">
                    <input type="text" id="order-search" class="bel-form-control bel-form-input" placeholder="Enter Order Number, Referral ID or BEL Name">
                    <div id="order-search-suggestions" class="search-suggestions"></div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <h3>Instructions:</h3>
            <ol>
                <li>Click the "Filter" button to show the filter panel</li>
                <li>Type in the search input to test suggestions</li>
                <li>Suggestions should appear for order numbers, referral IDs, and BEL names</li>
            </ol>
        </div>
    </div>

    <!-- Mock data for testing -->
    <script>
        // Mock APP_DATA for testing
        window.APP_DATA = {
            orders: {
                history: [
                    {
                        orderNumber: "ADV-2024-001",
                        referralId: "BTW123456",
                        belName: "John Smith",
                        amount: 150.99,
                        status: "Completed",
                        orderDate: "2024-01-15"
                    },
                    {
                        orderNumber: "IOT-2024-002", 
                        referralId: "BUS987654",
                        belName: "Jane Doe",
                        amount: 89.50,
                        status: "Processing",
                        orderDate: "2024-01-16"
                    },
                    {
                        orderNumber: "ADV-2024-003",
                        referralId: "BDE456789",
                        belName: "Bob Johnson",
                        amount: 299.99,
                        status: "Completed", 
                        orderDate: "2024-01-17"
                    }
                ]
            }
        };

        // Mock appState
        window.appState = {
            orderFilters: {
                dateFrom: '',
                dateTo: '',
                search: '',
                amountMin: '',
                amountMax: '',
                status: ''
            },
            orderPagePayout: 1
        };

        // Mock utils.debounce
        window.utils = {
            debounce: function(func, delay) {
                let timeoutId;
                return function (...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            }
        };
    </script>
    
    <!-- Load the main app.js which contains setupOrderSearchSuggestions -->
    <script src="src/js/app.js"></script>
    
    <script>
        // Test script
        document.addEventListener('DOMContentLoaded', () => {
            // Setup filter button toggle
            const filterBtn = document.getElementById('order-filter-btn');
            const filterPanel = document.getElementById('order-filter-panel');
            
            if (filterBtn && filterPanel) {
                filterBtn.addEventListener('click', () => {
                    const isVisible = filterPanel.style.display !== 'none';
                    filterPanel.style.display = isVisible ? 'none' : 'block';
                    filterBtn.innerHTML = isVisible 
                        ? '<i class="fas fa-filter"></i> Filter'
                        : '<i class="fas fa-filter"></i> Hide Filters';
                    
                    console.log('Filter panel toggled:', !isVisible ? 'shown' : 'hidden');
                });
            }
            
            // Create a simple ContentManager to access the setupOrderSearchSuggestions method
            const TestContentManager = {
                setupOrderSearchSuggestions() {
                    const searchInput = document.getElementById('order-search');
                    const suggestionsContainer = document.getElementById('order-search-suggestions');
                    
                    if (!searchInput || !suggestionsContainer) {
                        console.error('Search elements not found!');
                        return;
                    }

                    console.log('Setting up order search suggestions...');

                    let selectedIndex = -1;
                    let suggestions = [];

                    // Get order data for suggestions
                    const getOrderData = () => {
                        if (!window.APP_DATA?.orders?.history) return [];
                        
                        return window.APP_DATA.orders.history.map(order => ({
                            orderNumber: order.orderNumber,
                            referralId: order.referralId,
                            belName: order.belName,
                            amount: order.amount,
                            status: order.status
                        }));
                    };

                    // Input event for showing suggestions
                    searchInput.addEventListener('input', utils.debounce((e) => {
                        const query = e.target.value.trim().toLowerCase();
                        selectedIndex = -1;
                        
                        if (query.length === 0) {
                            this.hideOrderSuggestions(suggestionsContainer);
                            return;
                        }

                        const orderData = getOrderData();
                        
                        // Find matching records
                        suggestions = [];
                        
                        orderData.forEach(order => {
                            // Check order number
                            if (order.orderNumber.toLowerCase().includes(query)) {
                                suggestions.push({
                                    displayText: order.orderNumber,
                                    subText: `${order.belName} - ${order.referralId}`,
                                    type: 'orderNumber',
                                    value: order.orderNumber
                                });
                            }
                            
                            // Check referral ID
                            if (order.referralId.toLowerCase().includes(query)) {
                                suggestions.push({
                                    displayText: order.referralId,
                                    subText: `${order.belName} - Order: ${order.orderNumber}`,
                                    type: 'referralId',
                                    value: order.referralId
                                });
                            }
                            
                            // Check BEL name
                            if (order.belName.toLowerCase().includes(query)) {
                                suggestions.push({
                                    displayText: order.belName,
                                    subText: `${order.referralId} - Order: ${order.orderNumber}`,
                                    type: 'belName',
                                    value: order.belName
                                });
                            }
                        });
                        
                        // Remove duplicates and limit to 8 results
                        suggestions = suggestions
                            .filter((suggestion, index, self) => 
                                index === self.findIndex(s => s.displayText === suggestion.displayText)
                            )
                            .slice(0, 8);

                        if (suggestions.length > 0) {
                            this.showOrderSuggestions(suggestions, query, suggestionsContainer, searchInput);
                        } else {
                            this.hideOrderSuggestions(suggestionsContainer);
                        }
                    }, 150));

                    // Keyboard navigation
                    searchInput.addEventListener('keydown', (e) => {
                        const suggestionItems = suggestionsContainer.querySelectorAll('.search-suggestion-item');
                        
                        switch (e.key) {
                            case 'ArrowDown':
                                e.preventDefault();
                                selectedIndex = Math.min(selectedIndex + 1, suggestionItems.length - 1);
                                this.highlightOrderSuggestion(suggestionItems, selectedIndex);
                                break;
                                
                            case 'ArrowUp':
                                e.preventDefault();
                                selectedIndex = Math.max(selectedIndex - 1, -1);
                                this.highlightOrderSuggestion(suggestionItems, selectedIndex);
                                break;
                                
                            case 'Enter':
                                e.preventDefault();
                                if (selectedIndex >= 0 && suggestions[selectedIndex]) {
                                    this.selectOrderSuggestion(suggestions[selectedIndex], searchInput);
                                }
                                break;
                                
                            case 'Escape':
                                this.hideOrderSuggestions(suggestionsContainer);
                                selectedIndex = -1;
                                break;
                        }
                    });

                    // Click outside to hide suggestions
                    document.addEventListener('click', (e) => {
                        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                            this.hideOrderSuggestions(suggestionsContainer);
                        }
                    });

                    // Focus event to show suggestions if there's a value
                    searchInput.addEventListener('focus', () => {
                        if (searchInput.value.trim().length > 0) {
                            searchInput.dispatchEvent(new Event('input'));
                        }
                    });
                },

                showOrderSuggestions(suggestions, query, suggestionsContainer, searchInput) {
                    if (!suggestionsContainer) return;

                    const html = suggestions.map((suggestion, index) => {
                        const highlightedText = this.highlightOrderMatch(suggestion.displayText, query);
                        return `
                            <div class="search-suggestion-item" data-index="${index}">
                                <div class="suggestion-name">${highlightedText}</div>
                                <div class="suggestion-id">${suggestion.subText}</div>
                            </div>
                        `;
                    }).join('');

                    suggestionsContainer.innerHTML = html;
                    suggestionsContainer.classList.add('show');

                    // Add click listeners to suggestion items
                    suggestionsContainer.querySelectorAll('.search-suggestion-item').forEach((item, index) => {
                        item.addEventListener('click', () => {
                            this.selectOrderSuggestion(suggestions[index], searchInput);
                        });
                    });
                },

                hideOrderSuggestions(suggestionsContainer) {
                    if (suggestionsContainer) {
                        suggestionsContainer.classList.remove('show');
                        suggestionsContainer.innerHTML = '';
                    }
                },

                highlightOrderSuggestion(items, index) {
                    items.forEach((item, i) => {
                        item.classList.toggle('highlighted', i === index);
                    });
                },

                selectOrderSuggestion(suggestion, searchInput) {
                    if (searchInput) {
                        searchInput.value = suggestion.displayText;
                        const suggestionsContainer = searchInput.nextElementSibling;
                        this.hideOrderSuggestions(suggestionsContainer);
                        
                        console.log('Selected suggestion:', suggestion);
                        
                        // Trigger filter update here if needed
                        // applyFilters();
                    }
                },

                highlightOrderMatch(text, query) {
                    if (!query) return text;
                    
                    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    return text.replace(regex, '<mark style="background-color: var(--ds-color-primary-light-30); font-weight: var(--fw-semibold);">$1</mark>');
                }
            };
            
            // Initialize the search suggestions
            TestContentManager.setupOrderSearchSuggestions();
            
            console.log('Test page loaded. Click the Filter button to show the search functionality.');
        });
    </script>
</body>
</html>
